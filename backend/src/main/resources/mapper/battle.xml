<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shinhan.walfi.mapper.BattleMapper">

    <resultMap id="battleRank" type="com.shinhan.walfi.dto.game.BattleRankResDto">
        <result column="user_id" property="userId"></result>
        <result column="sum_occupy_time" property="sumOccupyTime"></result>
    </resultMap>

    <insert id="write">
        insert into battle_history (battle_idx, user_id, occupy_time, branch_idx)
        values (null, #{userId}, timestampdiff(second, #{startTime},now()), #{branchIdx} );
    </insert>

    <select id="getRank" resultMap="battleRank">
        select distinct user_id, sum(occupy_time) over (partition by user_id) sum_occupy_time
        from battle_history
        where branch_idx = #{idx}
        order by sum_occupy_time desc;
    </select>
</mapper>